<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Learning Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Drag and Drop Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .activity-container {
            border-left: 4px solid #cbd5e1;
        }

        .step-card {
            transition: transform 0.1s ease;
        }

        /* Sortable ghost styles */
        .sortable-ghost {
            opacity: 0.3;
            background-color: #f1f5f9 !important;
            border: 2px dashed #94a3b8 !important;
        }

        .sortable-drag {
            cursor: grabbing;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Pedagogical Color Codes */
        .type-acquisition { border-left: 8px solid #a1f5ed; }
        .type-collaboration { border-left: 8px solid #ffd966; }
        .type-discussion { border-left: 8px solid #7aaeea; }
        .type-investigation { border-left: 8px solid #f8807f; }
        .type-practice { border-left: 8px solid #bb98dc; }
        .type-production { border-left: 8px solid #bdea75; }

        .select-acquisition { background-color: #a1f5ed; color: #000; border-color: #7dded6; }
        .select-collaboration { background-color: #ffd966; color: #000; border-color: #f0c953; }
        .select-discussion { background-color: #7aaeea; color: #000; border-color: #6a9bd6; }
        .select-investigation { background-color: #f8807f; color: #000; border-color: #e06e6d; }
        .select-practice { background-color: #bb98dc; color: #000; border-color: #a582c6; }
        .select-production { background-color: #bdea75; color: #000; border-color: #a6d15e; }

        .drag-handle {
            cursor: grab;
            touch-action: none;
            user-select: none;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        .nav-tab.active {
            background-color: white;
            color: #4f46e5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Helper for Material Icons vertical alignment */
        .material-icons-round {
            display: inline-flex;
            vertical-align: middle;
            align-items: center;
            justify-content: center;
        }

        /* Foldable Panel Transition */
        .panel-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .panel-content.open {
            max-height: 2000px;
            opacity: 1;
        }
        .rotate-icon {
            transition: transform 0.3s ease;
        }
        .rotate-icon.open {
            transform: rotate(180deg);
        }

        /* Step Body Foldable */
        .step-body {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s;
            max-height: 2000px;
            opacity: 1;
            overflow: hidden;
        }
        .step-body.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        /* Activity Body Foldable */
        .activity-body {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 5000px;
            opacity: 1;
            overflow: hidden;
        }
        .activity-body.collapsed {
            max-height: 0;
            opacity: 0;
        }

        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .activity-group { break-inside: avoid; margin-bottom: 2rem; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; }
            .step-card { border: 1px solid #e2e8f0; break-inside: avoid; margin-bottom: 1rem; }
            select { appearance: none; border: none; padding: 0; background: none; }
            textarea { border: none; padding: 0; }
            #key-params-panel { max-height: none !important; opacity: 1 !important; display: block !important; }
            #help-panel { display: none; }
            .step-body.collapsed, .activity-body.collapsed { max-height: none !important; opacity: 1 !important; display: block !important; }
            #designer-toolbar { display: none; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col xl:flex-row xl:items-end justify-between mb-8 gap-6">
            <div class="mb-2 xl:mb-0">
                <h1 class="text-3xl font-bold text-slate-900" data-i18n="app_title">Learning Designer</h1>
                <p class="text-slate-500" data-i18n="app_subtitle">Pedagogical Design</p>
            </div>

            <div class="flex flex-wrap gap-6 no-print items-end">

                <!-- Project Group -->
                <div class="flex flex-col gap-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1" data-i18n="grp_project">Project</span>
                    <div class="flex items-center bg-white border border-slate-200 rounded-lg p-1 gap-1 shadow-sm h-[46px]">
                        <button onclick="saveProject()" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-md transition-colors flex items-center gap-2" data-i18n-title="title_save_project">
                            <span class="material-icons-round text-xl">save</span>
                            <span class="text-sm font-medium hidden md:inline" data-i18n="btn_save">Save</span>
                        </button>
                        <button onclick="triggerFileLoad()" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-md transition-colors flex items-center gap-2" data-i18n-title="title_load_project">
                            <span class="material-icons-round text-xl">file_upload</span>
                            <span class="text-sm font-medium hidden md:inline" data-i18n="btn_load">Load</span>
                        </button>
                        <div class="w-px bg-slate-200 my-1 mx-1"></div>

                        <!-- Export Dropdown -->
                        <div class="relative group">
                            <div class="flex items-center">
                                <select onchange="handleExport(this)" class="appearance-none bg-transparent hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 pl-3 pr-8 py-2 rounded-md transition-colors outline-none cursor-pointer text-sm font-medium h-[36px]" data-i18n-title="title_export_dropdown">
                                    <option value="" disabled selected data-i18n="btn_export_dropdown">Export...</option>
                                    <option value="markdown" data-i18n="opt_md">Markdown (for GenAI)</option>
                                    <option value="pdf" data-i18n="opt_pdf">PDF</option>
                                    <option value="richtext" data-i18n="opt_rtf">Rich Text</option>
                                    <option value="rtf" data-i18n="opt_real_rtf">Text (.rtf)</option>
                                </select>
                                <span class="material-icons-round text-slate-400 pointer-events-none absolute right-2 text-lg">expand_more</span>
                            </div>
                        </div>

                        <button onclick="exportTerminology()" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-md transition-colors flex items-center gap-2" data-i18n-title="title_export_term">
                            <span class="material-icons-round text-xl">translate</span>
                        </button>
                        <input type="file" id="load-file-input" class="hidden" accept=".json" onchange="loadProject(event)" />
                    </div>
                </div>

                <!-- View Group -->
                <div class="flex flex-col gap-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1" data-i18n="grp_view">View</span>
                    <div class="flex items-center bg-white border border-slate-200 rounded-lg p-1 gap-2 shadow-sm h-[46px]">
                        <button onclick="toggleAllActivities()" id="btn-toggle-all-header" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded-md transition-colors flex items-center justify-center ml-1" data-i18n-title="title_fold_all">
                            <span id="icon-toggle-all" class="material-icons-round text-2xl">unfold_less</span>
                        </button>
                        <div class="w-px h-6 bg-slate-200"></div>
                        <button onclick="toggleLanguage()" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded-md transition-colors flex items-center gap-1" data-i18n-title="title_switch_language">
                            <span class="material-icons-round text-lg">language</span>
                            <span id="lang-btn-text" class="text-sm font-bold">FR</span>
                        </button>
                        <div class="w-px h-6 bg-slate-200"></div></div>
                </div>

                <!-- Help Group -->
                <div class="flex flex-col gap-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1" data-i18n="grp_help">Help</span>
                    <div class="flex items-center bg-white border border-slate-200 rounded-lg p-1 gap-2 shadow-sm h-[46px]">
                        <button onclick="togglePanel('help-panel')" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-1 rounded-md transition-colors flex items-center justify-center" data-i18n-title="title_help">
                            <span class="material-icons-round text-2xl">help_outline</span>
                        </button>
                    </div>
                </div>

            </div>
        </header>

        <!-- Help Panel -->
        <div id="help-panel" class="mb-6 bg-blue-50 rounded-xl shadow-sm border border-blue-100 overflow-hidden panel-content no-print">
            <div class="p-6 text-slate-700">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold text-indigo-800 flex items-center gap-2">
                        <span class="material-icons-round">info</span>
                        <span data-i18n="help_title">How to use Learning Designer</span>
                    </h2>
                    <button onclick="togglePanel('help-panel')" class="text-slate-400 hover:text-slate-600"><span class="material-icons-round">close</span></button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-sm">
                    <div>
                        <h3 class="font-bold text-indigo-700 mb-2 uppercase text-xs tracking-wider" data-i18n="help_structure_title">1. Design Structure</h3>
                        <p class="mb-2" data-i18n="help_structure_text">Build your course by adding <strong>Activities</strong> (modules/topics) and filling them with <strong>Steps</strong> (specific tasks). Reorder items using the drag handles <span class="inline-block align-middle"><span class="material-icons-round text-base text-slate-400">drag_indicator</span></span>.</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-indigo-700 mb-2 uppercase text-xs tracking-wider" data-i18n="help_types_title">2. Learning Types</h3>
                        <p class="mb-2" data-i18n="help_types_intro">Select a pedagogical type for each step:</p>
                        <ul class="space-y-1">
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#a1f5ed]"></span> <span data-i18n="type_acquisition">Acquisition</span></li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#ffd966]"></span> <span data-i18n="type_collaboration">Collaboration</span></li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#7aaeea]"></span> <span data-i18n="type_discussion">Discussion</span></li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#f8807f]"></span> <span data-i18n="type_investigation">Investigation</span></li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#bb98dc]"></span> <span data-i18n="type_practice">Practice</span></li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#bdea75]"></span> <span data-i18n="type_production">Production</span></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-indigo-700 mb-2 uppercase text-xs tracking-wider" data-i18n="help_export_title">3. Save & Export</h3>
                        <p class="mb-2" data-i18n="help_export_text"><strong>Save/Load:</strong> Keep your work in a .json file.<br><strong>Export:</strong> Generate files in Markdown (GenAI), PDF, or Rich Text formats.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Parameters -->
        <div class="mb-6 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <button onclick="togglePanel('key-params-panel')" class="w-full px-5 py-3 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition-colors no-print" data-i18n-title="title_toggle_panel">
                <div class="flex items-center gap-2">
                    <span class="material-icons-round text-slate-500">tune</span>
                    <span class="font-bold text-slate-700 uppercase text-sm tracking-wide" data-i18n="panel_key_parameters">Parameters</span>
                </div>
                <span id="key-params-panel-icon" class="material-icons-round text-slate-400 rotate-icon">expand_more</span>
            </button>
            <div id="key-params-panel" class="panel-content">
                <div class="p-5 border-t border-slate-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_course_name">Training Name</label>
                        <input type="text" id="param-name" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter training name..." data-i18n-placeholder="ph_course_name" />
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_topic">Topic</label>
                        <input type="text" id="param-topic" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter topic..." data-i18n-placeholder="ph_topic" />
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_authors">Author(s)</label>
                        <input type="text" id="param-authors" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter author name(s)..." data-i18n-placeholder="ph_authors" />
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_mode">Mode of delivery</label>
                        <select id="param-mode" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="" disabled selected data-i18n="opt_mode_placeholder">Select a mode…</option>
                            <option value="online" data-i18n="opt_mode_online">Wholly online</option>
                            <option value="blended" data-i18n="opt_mode_blended">Blended</option>
                            <option value="classroom" data-i18n="opt_mode_classroom">Classroom-based</option>
                            <option value="location" data-i18n="opt_mode_location">Location-based</option>
                            <option value="other" data-i18n="opt_mode_other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_class_size">Cohort Size</label>
                        <input type="number" id="global-class-size" oninput="updateStats()" value="30" min="1" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-slate-800" />
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_learning_time">Learning Time (Target)</label>
                        <div class="flex gap-2">
                            <input type="number" id="param-learning-val" oninput="updateStats()" placeholder="0" min="0" class="w-2/3 px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                            <select id="param-learning-unit" onchange="updateStats()" class="w-1/3 px-1 py-2 text-xs border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="mins" data-i18n="unit_mins">Mins</option>
                                <option value="hours" data-i18n="unit_hours">Hours</option>
                                <option value="days" data-i18n="unit_days">Days</option>
                                <option value="weeks" data-i18n="unit_weeks">Weeks</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_designed_time">Designed Time (Planned)</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" id="param-designed-val" placeholder="0" min="0" class="w-2/3 px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-100 text-slate-500" readonly />
                            <span id="param-designed-unit-display" class="w-1/3 text-sm text-slate-600 font-bold px-1">mins</span>
                        </div>
                    </div>

                    <div class="md:col-span-2 lg:col-span-3">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_aims">Aims</label>
                        <textarea id="param-aims" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="..." data-i18n-placeholder="ph_aims"></textarea>
                    </div>

                    <div class="md:col-span-2 lg:col-span-3">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_outcomes">Learning Outcomes</label>
                        <div class="flex gap-2 mb-2 no-print flex-col sm:flex-row">
                            <div class="flex gap-2">
                                <select id="new-bloom-level" onchange="updateHeaderBloomSub()" class="text-[11px] font-bold text-slate-600 border border-slate-200 rounded-lg py-2 px-1 bg-white focus:ring-1 focus:ring-indigo-500 outline-none w-28">
                                    <option value="" disabled selected data-i18n="bloom_placeholder">Bloom...</option>
                                </select>
                                <select id="new-bloom-sub" class="text-[11px] text-slate-600 border border-slate-200 rounded-lg py-2 px-1 bg-white focus:ring-1 focus:ring-indigo-500 outline-none w-28 hidden">
                                    <option value="" disabled selected data-i18n="bloom_sub_placeholder">Sub-cat...</option>
                                </select>
                            </div>
                            <div class="flex flex-1 gap-2">
                                <input type="text" id="new-outcome-input" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Add an outcome..." data-i18n-placeholder="ph_add_outcome" onkeypress="handleOutcomeEnter(event)" />
                                <button onclick="addOutcome()" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg font-bold hover:bg-indigo-200 transition-colors flex items-center justify-center" data-i18n-title="title_add_outcome">
                                    <span class="material-icons-round">add</span>
                                </button>
                            </div>
                        </div>
                        <ul id="outcomes-list" class="space-y-1"></ul>
                        <p id="no-outcomes-text" class="text-sm text-slate-400 italic mt-2" data-i18n="text_no_outcomes">No outcomes are set</p>
                    </div>

                    <div class="md:col-span-2 lg:col-span-3">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" data-i18n="label_description">General Description</label>
                        <textarea id="param-description" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-y" placeholder="Detailed description..." data-i18n-placeholder="ph_description"></textarea>
                    </div>

                </div>
            </div>
        </div>

        <!-- Global Stats Display -->
        <div class="mb-4 no-print flex flex-col md:flex-row gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col justify-center">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center w-full mb-3 gap-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-xs font-bold uppercase tracking-wider" data-i18n="label_learning_time">Learning Time (Target)</span>
                            <div class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1 shadow-sm">
                                <span id="header-target-time" class="text-sm font-bold text-slate-600">0 Mins</span>
                            </div>
                        </div>

                        <div class="hidden sm:block w-px h-6 bg-slate-200"></div>

                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-xs font-bold uppercase tracking-wider" data-i18n="label_designed_time">Designed Time (Planned)</span>
                            <div class="bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-1 shadow-sm">
                                <span id="total-duration" class="text-sm font-bold text-indigo-700">0 mins</span>
                            </div>
                        </div>
                    </div>

                    <div class="text-right">
                        <span class="text-slate-400 text-xs italic" id="stats-update-info" data-i18n="status_calculating">Auto-calculating...</span>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="w-full flex flex-col gap-4 mt-2">
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider" data-i18n="label_timeline_structure">Structure (Activities)</span>
                        <div id="timeline-activities" class="w-full h-8 flex rounded-md overflow-hidden bg-slate-100 border border-slate-200 cursor-help"></div>
                        <div id="timeline-activities-labels" class="w-full flex text-[10px] text-slate-500 font-medium"></div>
                    </div>

                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider" data-i18n="label_timeline_pedagogy">Pedagogy (Learning Types)</span>
                        <div id="timeline-steps" class="w-full h-8 flex rounded-md overflow-hidden bg-slate-100 border border-slate-200 cursor-help"></div>
                    </div>

                    <div id="timeline-ruler" class="w-full h-5 relative mt-0 select-none pointer-events-none"></div>
                </div>

            </div>
        </div>

        <!-- Main Actions -->
        <div class="mb-8 no-print flex justify-start">
            <button onclick="addActivity()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg font-bold shadow-md hover:shadow-lg flex items-center gap-2 transition-all transform hover:-translate-y-0.5" data-i18n-title="title_new_activity">
                <span class="material-icons-round text-2xl">add_circle</span>
                <span data-i18n="btn_new_activity">New Activity/Module</span>
            </button>
        </div>

        <!-- Designer -->
        <div id="view-designer">
            <div class="flex justify-end mb-4 no-print">
                <button onclick="toggleAllActivities()" class="text-slate-500 hover:text-indigo-600 text-sm font-medium flex items-center gap-1 transition-colors px-3 py-1.5 rounded-lg hover:bg-slate-100" id="btn-toggle-all-main">
                    <span id="icon-toggle-all-main" class="material-icons-round text-xl">unfold_less</span>
                    <span id="text-toggle-all-main" data-i18n="btn_collapse_all">Collapse All</span>
                </button>
            </div>

            <div id="activities-root" class="space-y-12"></div>

            <div id="empty-state" class="hidden text-center py-20 bg-white rounded-2xl border-2 border-dashed border-slate-300">
                <h3 class="mt-2 text-lg font-medium text-slate-900" data-i18n="empty_title">No activities designed yet</h3>
                <p class="mt-1 text-sm text-slate-500" data-i18n="empty_subtitle">Start by creating your first Activity container.</p>
                <button onclick="addActivity()" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700" data-i18n-title="title_create_activity">
                    <span class="material-icons-round mr-2">add</span> <span data-i18n="btn_create_activity">Create Activity</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 mb-6 text-center text-xs text-slate-400 no-print">
            <p>François Jourde (2026) - CC BY SA, inspired by the <a href="https://www.ucl.ac.uk/learning-designer/" target="_blank" class="underline hover:text-slate-500">Learning Designer</a> (UCL Knowledge Lab, UCL Institute of Education).</p>
            <p class="mt-2" data-i18n="footer_disclaimer">This site does not use tracking or session cookies. No personal data is processed online.</p>
            <p class="mt-1 italic opacity-75" data-i18n="footer_ai_disclaimer">This application was created mainly using generative AI coding; the code may contain flaws.</p>
            <p class="mt-1" data-i18n="footer_github">Code available at <a href="https://github.com/jourde/artefacts" target="_blank" class="underline hover:text-slate-500">https://github.com/jourde/artefacts</a></p>
        </footer>
    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full">
            <h3 class="text-lg font-bold text-slate-800 mb-2" data-i18n="modal_confirm_title">Confirm Action</h3>
            <p id="custom-confirm-msg" class="text-slate-600 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-3">
                <button id="custom-confirm-no" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors" data-i18n="btn_cancel">Cancel</button>
                <button id="custom-confirm-yes" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded-lg font-medium transition-colors" data-i18n="btn_delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="global-tooltip" class="fixed z-[100] hidden bg-slate-800 text-white text-xs font-medium rounded-lg px-3 py-2 pointer-events-none shadow-2xl border border-slate-700 max-w-[250px] whitespace-normal leading-tight"></div>

    <!-- Templates -->
    <template id="activity-template">
        <div class="activity-group relative">
            <div class="flex flex-col sm:flex-row sm:items-start justify-between mb-4 px-2 gap-4">
                <div class="flex-1 flex items-start gap-4">
                    <div class="drag-handle-activity drag-handle text-slate-300 hover:text-slate-500 no-print flex items-center justify-center w-8 h-8 cursor-grab mt-1">
                        <span class="material-icons-round text-2xl">drag_indicator</span>
                    </div>
                    <div class="h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600 activity-index shrink-0">1</div>
                    <div class="flex-1 w-full">
                        <input type="text" oninput="updateStats()" placeholder="Activity Title" data-i18n-placeholder="ph_activity_title" class="activity-title text-xl font-bold text-slate-800 bg-transparent border-b-2 border-transparent hover:border-slate-300 focus:border-indigo-500 outline-none w-full py-1 transition-colors" />

                        <div class="flex items-center gap-3 mt-1 pr-2">
                            <div class="activity-type-bar flex-1 h-2.5 bg-slate-100 border border-slate-200 rounded-full overflow-hidden flex"></div>
                            <span class="activity-total-time text-[10px] font-bold text-slate-400 w-12 text-right font-mono">0m</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3 no-print mt-1">
                    <button onclick="toggleActivity(this)" class="text-slate-400 hover:text-indigo-500 p-2 transition-colors" title="Toggle Activity" data-i18n-title="title_toggle_panel">
                        <span class="material-icons-round text-2xl rotate-icon">expand_more</span>
                    </button>
                    <button onclick="duplicateActivity(this)" class="text-slate-400 hover:text-indigo-500 p-2 transition-colors" title="Duplicate Activity" data-i18n-title="title_duplicate_activity">
                        <span class="material-icons-round text-2xl">content_copy</span>
                    </button>
                    <button onclick="deleteActivity(this)" class="text-slate-400 hover:text-red-500 p-2 transition-colors" title="Delete Activity" data-i18n-title="title_delete_activity">
                        <span class="material-icons-round text-2xl">delete_outline</span>
                    </button>
                </div>
            </div>

            <div class="activity-body panel-content open">
                <div class="mb-4 ml-12 pr-2">
                    <textarea rows="2" placeholder="Activity Description..." data-i18n-placeholder="ph_activity_desc" class="activity-description w-full px-3 py-2 text-sm text-slate-600 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-y bg-slate-50"></textarea>
                </div>
                <div class="activity-steps-container activity-container ml-5 pl-8 space-y-4 min-h-[50px]"></div>
                <div class="mt-4 pt-2 flex justify-center no-print border-t border-slate-100">
                    <button onclick="addStepToActivity(this)" class="text-sm font-semibold text-slate-400 hover:text-indigo-600 px-4 py-2 rounded-lg transition-colors flex items-center gap-2 hover:bg-slate-50" data-i18n-title="title_add_step">
                        <span class="material-icons-round text-base">add</span>
                        <span data-i18n="btn_add_step">Add Step</span>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="step-template">
        <div class="step-card bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative group flex flex-col type-acquisition">
            <div class="flex items-center gap-3 p-3 border-b border-transparent hover:border-slate-100 transition-colors">
                <div class="drag-handle-step drag-handle flex items-center justify-center text-slate-300 hover:text-slate-500 cursor-grab">
                    <span class="material-icons-round text-xl">drag_indicator</span>
                </div>

                <div class="flex-1">
                    <input type="text" placeholder="Title..." data-i18n-placeholder="ph_step_title" class="step-input-title w-full px-2 py-1 text-sm font-bold text-slate-700 border-none bg-transparent focus:ring-0 outline-none" />
                </div>

                <div class="w-32">
                    <select onchange="updateStepType(this)" class="learning-type-select w-full px-2 py-1 text-xs font-bold border rounded-lg focus:ring-1 focus:ring-indigo-500 outline-none transition-all select-acquisition">
                        <option value="acquisition" data-i18n="type_acquisition">Acquisition</option>
                        <option value="collaboration" data-i18n="type_collaboration">Collaboration</option>
                        <option value="discussion" data-i18n="type_discussion">Discussion</option>
                        <option value="investigation" data-i18n="type_investigation">Investigation</option>
                        <option value="practice" data-i18n="type_practice">Practice</option>
                        <option value="production" data-i18n="type_production">Production</option>
                    </select>
                </div>

                <div class="flex items-center gap-1 no-print">
                    <button onclick="toggleStep(this)" class="text-slate-400 hover:text-indigo-500 p-1" title="Toggle Details" data-i18n-title="title_toggle_panel">
                        <span class="material-icons-round text-lg rotate-icon">expand_more</span>
                    </button>
                    <button onclick="duplicateStep(this)" class="text-slate-300 hover:text-indigo-500 p-1" title="Duplicate Step" data-i18n-title="title_duplicate_step">
                        <span class="material-icons-round text-lg">content_copy</span>
                    </button>
                    <button onclick="deleteStep(this)" class="text-slate-300 hover:text-red-400 p-1" title="Delete Step" data-i18n-title="title_delete_step">
                        <span class="material-icons-round text-lg">close</span>
                    </button>
                </div>
            </div>

            <div class="step-body panel-content open p-5 pt-0">
                <div class="flex flex-col lg:flex-row gap-6 mt-4">
                    <div class="lg:w-1/3 space-y-4">
                        <div class="grid grid-cols-1 gap-3">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase -mb-2 flex items-center gap-1">
                                <span class="material-icons-round text-sm text-slate-400">schedule</span>
                                <span data-i18n="label_duration">Duration</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="number" oninput="updateStats()" placeholder="0" min="0" class="duration-input w-2/3 px-3 py-1.5 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                <select onchange="updateStats()" class="duration-unit w-1/3 px-1 py-1.5 text-[11px] border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="60" data-i18n="unit_mins">Mins</option>
                                    <option value="3600" data-i18n="unit_hours">Hours</option>
                                    <option value="86400" data-i18n="unit_days">Days</option>
                                    <option value="604800" data-i18n="unit_weeks">Weeks</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">
                                <span class="material-icons-round text-sm text-slate-400">groups</span>
                                <span data-i18n="label_grouping">Grouping</span>
                            </label>
                            <div class="space-y-1">
                                <select onchange="toggleGroupMode(this)" class="step-group-mode w-full px-2 py-1.5 text-xs rounded-lg border border-slate-200 bg-white outline-none">
                                    <option value="class" data-i18n="opt_whole_class">Whole Class</option>
                                    <option value="groups" data-i18n="opt_groups">Groups</option>
                                </select>
                                <div class="step-group-details hidden flex gap-2">
                                    <div class="relative flex-1">
                                        <input type="number" min="1" oninput="updateGroupMath(this, 'count')" placeholder="Nb groups" data-i18n-placeholder="ph_nb_groups" class="step-group-count w-full px-2 py-1 text-xs border border-slate-200 rounded-lg focus:ring-1 focus:ring-indigo-500 outline-none" />
                                        <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[9px] text-slate-400 pointer-events-none pr-1" data-i18n="label_short_groups">Grps</span>
                                    </div>
                                    <div class="relative flex-1">
                                        <input type="number" min="1" oninput="updateGroupMath(this, 'size')" placeholder="Per group" data-i18n-placeholder="ph_per_group" class="step-group-size w-full px-2 py-1 text-xs border border-slate-200 rounded-lg focus:ring-1 focus:ring-indigo-500 outline-none" />
                                        <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[9px] text-slate-400 pointer-events-none pr-1" data-i18n="label_short_pers">Pers</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2 pt-1 border-t border-slate-100">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] w-14 text-slate-400 font-bold uppercase flex items-center gap-1">
                                    <span class="material-icons-round text-[10px]">face</span>
                                    <span data-i18n="label_trainer">Trainer</span>
                                </span>
                                <select onchange="updateStats()" class="trainer-select flex-1 px-2 py-1 text-xs rounded-md border border-slate-200 bg-white outline-none">
                                    <option value="present" data-i18n="opt_present">Present</option>
                                    <option value="absent" data-i18n="opt_absent">Absent</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] w-14 text-slate-400 font-bold uppercase flex items-center gap-1">
                                    <span class="material-icons-round text-[10px]">place</span>
                                    <span data-i18n="label_place">Place</span>
                                </span>
                                <select onchange="updateStats()" class="place-select flex-1 px-2 py-1 text-xs rounded-md border border-slate-200 bg-white outline-none">
                                    <option value="situ" data-i18n="opt_insitu">In Situ</option>
                                    <option value="online" data-i18n="opt_online">Online</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] w-14 text-slate-400 font-bold uppercase flex items-center gap-1">
                                    <span class="material-icons-round text-[10px]">event</span>
                                    <span data-i18n="label_time">Time</span>
                                </span>
                                <select onchange="updateStats()" class="time-select flex-1 px-2 py-1 text-xs rounded-md border border-slate-200 bg-white outline-none">
                                    <option value="sync" data-i18n="opt_sync">Synchronous</option>
                                    <option value="async" data-i18n="opt_async">Asynchronous</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="lg:w-2/3 space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">
                                <span class="material-icons-round text-sm text-slate-400">assignment</span>
                                <span data-i18n="label_tasks">What learners must do</span>
                            </label>
                            <textarea rows="6" placeholder="Instructions..." data-i18n-placeholder="ph_tasks" class="step-input-tasks w-full px-4 py-3 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">
                                <span class="material-icons-round text-sm text-slate-400">comment</span>
                                <span data-i18n="label_notes">Notes</span>
                            </label>
                            <textarea rows="3" placeholder="Trainer notes..." data-i18n-placeholder="ph_notes" class="step-input-notes w-full px-4 py-3 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none bg-slate-50 text-slate-600 italic"></textarea>
                        </div>
                    </div>
                </div>

                <div class="absolute top-2 right-2 flex flex-col gap-1 no-print opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="duplicateStep(this)" class="text-slate-300 hover:text-indigo-500 p-1" title="Duplicate Step" data-i18n-title="title_duplicate_step">
                        <span class="material-icons-round text-lg">content_copy</span>
                    </button>
                    <button onclick="deleteStep(this)" class="text-slate-300 hover:text-red-400 p-1" title="Delete Step" data-i18n-title="title_delete_step">
                        <span class="material-icons-round text-lg">close</span>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <script>
        /*
          This file is intended to be runnable standalone.
          The previous canvas version contained UI only and referenced undefined functions (e.g. addActivity).
          The implementation below provides the required logic for all inline onclick/onchange handlers.
        */

        // ----------------------------
        // Utilities
        // ----------------------------
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const TYPE_COLOURS = {
            acquisition: '#a1f5ed',
            collaboration: '#ffd966',
            discussion: '#7aaeea',
            investigation: '#f8807f',
            practice: '#bb98dc',
            production: '#bdea75'
        };

        const TYPE_CLASS = {
            acquisition: 'type-acquisition',
            collaboration: 'type-collaboration',
            discussion: 'type-discussion',
            investigation: 'type-investigation',
            practice: 'type-practice',
            production: 'type-production'
        };

        const SELECT_CLASS = {
            acquisition: 'select-acquisition',
            collaboration: 'select-collaboration',
            discussion: 'select-discussion',
            investigation: 'select-investigation',
            practice: 'select-practice',
            production: 'select-production'
        };

        function safeNumber(v, fallback = 0) {
            const n = Number(v);
            return Number.isFinite(n) ? n : fallback;
        }

        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function downloadText(filename, content, mime = 'text/plain;charset=utf-8') {
            const blob = new Blob([content], { type: mime });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(a.href), 500);
        }

        function formatDuration(totalSeconds) {
            const mins = Math.round(totalSeconds / 60);
            if (mins < 60) return `${mins} min${mins === 1 ? '' : 's'}`;
            const hours = mins / 60;
            if (hours < 24) return `${hours.toFixed(hours % 1 === 0 ? 0 : 1)} h`;
            const days = hours / 24;
            return `${days.toFixed(days % 1 === 0 ? 0 : 1)} d`;
        }

        function convertSecondsToUnit(totalSeconds, unit) {
            switch (unit) {
                case 'mins': return totalSeconds / 60;
                case 'hours': return totalSeconds / 3600;
                case 'days': return totalSeconds / 86400;
                case 'weeks': return totalSeconds / 604800;
                default: return totalSeconds / 60;
            }
        }

        // ----------------------------
        // i18n (minimal but functional)
        // ----------------------------
        let CURRENT_LANG = 'en';

        const I18N = {
            en: {
                app_title: 'Learning Designer',
                app_subtitle: 'Pedagogical Design',
                grp_project: 'Project',
                btn_save: 'Save',
                btn_load: 'Load',
                btn_export_dropdown: 'Export...',
                opt_md: 'Markdown (for GenAI)',
                opt_pdf: 'PDF',
                opt_rtf: 'Rich Text',
                opt_real_rtf: 'Text (.rtf)',
                grp_view: 'View',
                grp_help: 'Help',
                tab_designer: 'Designer',
                help_title: 'How to use Learning Designer',
                help_structure_title: '1. Design Structure',
                help_structure_text: 'Build your course by adding <strong>Activities</strong> (modules/topics) and filling them with <strong>Steps</strong> (specific tasks). Reorder items using the drag handles <span class="inline-block align-middle"><span class="material-icons-round text-base text-slate-400">drag_indicator</span></span>.',
                help_types_title: '2. Learning Types',
                help_types_intro: 'Select a pedagogical type for each step:',
                help_export_title: '3. Save & Export',
                help_export_text: '<strong>Save/Load:</strong> Keep your work in a .json file.<br><strong>Export:</strong> Generate files in Markdown (GenAI), PDF, or Rich Text formats.',
                panel_key_parameters: 'Parameters',
                label_course_name: 'Training Name',
                ph_course_name: 'Enter training name...',
                label_topic: 'Topic',
                ph_topic: 'Enter topic...',
                label_authors: 'Author(s)',
                ph_authors: 'Enter author name(s)...',
                label_mode: 'Mode of delivery',
                opt_mode_placeholder: 'Select a mode…',
                opt_mode_online: 'Wholly online',
                opt_mode_blended: 'Blended',
                opt_mode_classroom: 'Classroom-based',
                opt_mode_location: 'Location-based',
                opt_mode_other: 'Other',
                label_class_size: 'Cohort Size',
                label_learning_time: 'Learning Time (Target)',
                label_designed_time: 'Designed Time (Planned)',
                unit_mins: 'Mins',
                unit_hours: 'Hours',
                unit_days: 'Days',
                unit_weeks: 'Weeks',
                label_aims: 'Aims',
                ph_aims: '...',
                label_outcomes: 'Learning Outcomes',
                bloom_placeholder: 'Bloom...',
                bloom_sub_placeholder: 'Sub-cat...',
                ph_add_outcome: 'Add an outcome...',
                text_no_outcomes: 'No outcomes are set',
                label_description: 'General Description',
                ph_description: 'Detailed description...',
                label_timeline_structure: 'Structure (Activities)',
                label_timeline_pedagogy: 'Pedagogy (Learning Types)',
                status_calculating: 'Auto-calculating...',
                btn_new_activity: 'New Activity/Module',
                btn_collapse_all: 'Collapse All',
                empty_title: 'No activities designed yet',
                empty_subtitle: 'Start by creating your first Activity container.',
                btn_create_activity: 'Create Activity',
                footer_disclaimer: 'This site does not use tracking or session cookies. No personal data is processed online.',
                footer_ai_disclaimer: 'This application was created mainly using generative AI coding; the code may contain flaws.',
                footer_github: 'Code available at <a href="https://github.com/jourde/artefacts" target="_blank" class="underline hover:text-slate-500">https://github.com/jourde/artefacts</a>',
                modal_confirm_title: 'Confirm Action',
                btn_cancel: 'Cancel',
                btn_delete: 'Delete',
                ph_activity_title: 'Activity Title',
                ph_activity_desc: 'Activity Description...',
                btn_add_step: 'Add Step',
                ph_step_title: 'Title...',
                label_duration: 'Duration',
                label_grouping: 'Grouping',
                opt_whole_class: 'Whole Class',
                opt_groups: 'Groups',
                ph_nb_groups: 'Nb groups',
                label_short_groups: 'Grps',
                ph_per_group: 'Per group',
                label_short_pers: 'Pers',
                label_trainer: 'Trainer',
                opt_present: 'Present',
                opt_absent: 'Absent',
                label_place: 'Place',
                opt_insitu: 'In Situ',
                opt_online: 'Online',
                label_time: 'Time',
                opt_sync: 'Synchronous',
                opt_async: 'Asynchronous',
                label_tasks: 'What learners must do',
                ph_tasks: 'Instructions...',
                label_notes: 'Notes',
                ph_notes: 'Trainer notes...',
                type_acquisition: 'Acquisition',
                type_collaboration: 'Collaboration',
                type_discussion: 'Discussion',
                type_investigation: 'Investigation',
                type_practice: 'Practice',
                type_production: 'Production',
                title_save_project: 'Save project (.json)',
                title_load_project: 'Load project (.json)',
                title_export_dropdown: 'Export',
                title_export_term: 'Export terminology',
                title_fold_all: 'Fold/unfold all',
                title_switch_language: 'Switch language',
                title_tab_designer: 'Designer',
                title_help: 'Help',
                title_toggle_panel: 'Toggle panel',
                title_new_activity: 'Add a new activity',
                title_create_activity: 'Create activity',
                title_add_outcome: 'Add outcome',
                title_add_step: 'Add step',
                title_delete_activity: 'Delete activity',
                title_duplicate_activity: 'Duplicate activity',
                title_delete_step: 'Delete step',
                title_duplicate_step: 'Duplicate step'
            },
            fr: {
                app_title: 'Learning Designer',
                app_subtitle: 'Conception pédagogique',
                grp_project: 'Projet',
                btn_save: 'Enregistrer',
                btn_load: 'Charger',
                btn_export_dropdown: 'Exporter...',
                opt_md: 'Markdown (pour IA)',
                opt_pdf: 'PDF',
                opt_rtf: 'Texte riche',
                opt_real_rtf: 'Texte (.rtf)',
                grp_view: 'Affichage',
                grp_help: 'Aide',
                tab_designer: 'Conception',
                help_title: 'Comment utiliser Learning Designer',
                help_structure_title: '1. Structure',
                help_structure_text: 'Construisez votre formation en ajoutant des <strong>Activités</strong> (modules/thèmes) et en les remplissant d’<strong>Étapes</strong> (tâches). Réorganisez grâce aux poignées <span class="inline-block align-middle"><span class="material-icons-round text-base text-slate-400">drag_indicator</span></span>.',
                help_types_title: '2. Types d’apprentissage',
                help_types_intro: 'Choisissez un type pédagogique pour chaque étape :',
                help_export_title: '3. Enregistrer & exporter',
                help_export_text: '<strong>Enregistrer/Charger :</strong> Conservez votre travail au format .json.<br><strong>Exporter :</strong> Générez des fichiers en Markdown, PDF ou texte riche.',
                panel_key_parameters: 'Paramètres',
                label_course_name: 'Nom de la formation',
                ph_course_name: 'Saisir le nom...',
                label_topic: 'Thème',
                ph_topic: 'Saisir le thème...',
                label_authors: 'Auteur(s)',
                ph_authors: 'Saisir le(s) nom(s)...',
                label_mode: 'Modalité',
                opt_mode_placeholder: 'Choisir…',
                opt_mode_online: '100% en ligne',
                opt_mode_blended: 'Hybride',
                opt_mode_classroom: 'En présentiel',
                opt_mode_location: 'Sur site',
                opt_mode_other: 'Autre',
                label_class_size: 'Taille du groupe',
                label_learning_time: 'Temps cible',
                label_designed_time: 'Temps planifié',
                unit_mins: 'Min',
                unit_hours: 'Heures',
                unit_days: 'Jours',
                unit_weeks: 'Semaines',
                label_aims: 'Objectifs',
                ph_aims: '...',
                label_outcomes: 'Résultats d’apprentissage',
                bloom_placeholder: 'Bloom...',
                bloom_sub_placeholder: 'Sous-cat...',
                ph_add_outcome: 'Ajouter un résultat...',
                text_no_outcomes: 'Aucun résultat défini',
                label_description: 'Description générale',
                ph_description: 'Description détaillée...',
                label_timeline_structure: 'Structure (Activités)',
                label_timeline_pedagogy: 'Pédagogie (Types)',
                status_calculating: 'Calcul automatique...',
                btn_new_activity: 'Nouvelle activité/module',
                btn_collapse_all: 'Tout replier',
                empty_title: 'Aucune activité pour le moment',
                empty_subtitle: 'Commencez par créer votre première activité.',
                btn_create_activity: 'Créer une activité',
                footer_disclaimer: 'Ce site n’utilise pas de cookies de suivi. Aucune donnée personnelle n’est traitée en ligne.',
                footer_ai_disclaimer: 'Cette application a été créée principalement via du code généré ; le code peut contenir des défauts.',
                footer_github: 'Code disponible sur <a href="https://github.com/jourde/artefacts" target="_blank" class="underline hover:text-slate-500">https://github.com/jourde/artefacts</a>',
                modal_confirm_title: 'Confirmer',
                btn_cancel: 'Annuler',
                btn_delete: 'Supprimer',
                ph_activity_title: 'Titre de l’activité',
                ph_activity_desc: 'Description de l’activité...',
                btn_add_step: 'Ajouter une étape',
                ph_step_title: 'Titre...',
                label_duration: 'Durée',
                label_grouping: 'Organisation',
                opt_whole_class: 'Groupe classe',
                opt_groups: 'Groupes',
                ph_nb_groups: 'Nb groupes',
                label_short_groups: 'Grp',
                ph_per_group: 'Par groupe',
                label_short_pers: 'Pers',
                label_trainer: 'Formateur',
                opt_present: 'Présent',
                opt_absent: 'Absent',
                label_place: 'Lieu',
                opt_insitu: 'Sur site',
                opt_online: 'En ligne',
                label_time: 'Temps',
                opt_sync: 'Synchrone',
                opt_async: 'Asynchrone',
                label_tasks: 'Consignes apprenants',
                ph_tasks: 'Instructions...',
                label_notes: 'Notes',
                ph_notes: 'Notes formateur...',
                type_acquisition: 'Acquisition',
                type_collaboration: 'Collaboration',
                type_discussion: 'Discussion',
                type_investigation: 'Investigation',
                type_practice: 'Pratique',
                type_production: 'Production',
                title_save_project: 'Enregistrer le projet (.json)',
                title_load_project: 'Charger un projet (.json)',
                title_export_dropdown: 'Exporter',
                title_export_term: 'Exporter la terminologie',
                title_fold_all: 'Replier/déplier tout',
                title_switch_language: 'Changer de langue',
                title_tab_designer: 'Conception',
                title_help: 'Aide',
                title_toggle_panel: 'Afficher/masquer',
                title_new_activity: 'Ajouter une activité',
                title_create_activity: 'Créer une activité',
                title_add_outcome: 'Ajouter un résultat',
                title_add_step: 'Ajouter une étape',
                title_delete_activity: 'Supprimer l’activité',
                title_duplicate_activity: 'Dupliquer l’activité',
                title_delete_step: 'Supprimer l’étape',
                title_duplicate_step: 'Dupliquer l’étape'
            }
        };

        function applyI18n() {
            const dict = I18N[CURRENT_LANG] || I18N.en;

            // text/html
            $$('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if (dict[k] != null) el.innerHTML = dict[k];
            });

            // titles
            $$('[data-i18n-title]').forEach(el => {
                const k = el.getAttribute('data-i18n-title');
                if (dict[k] != null) el.setAttribute('title', dict[k]);
            });

            // placeholders
            $$('[data-i18n-placeholder]').forEach(el => {
                const k = el.getAttribute('data-i18n-placeholder');
                if (dict[k] != null) el.setAttribute('placeholder', dict[k]);
            });

            // language button label
            $('#lang-btn-text').textContent = (CURRENT_LANG === 'en') ? 'FR' : 'EN';
        }

        function toggleLanguage() {
            CURRENT_LANG = (CURRENT_LANG === 'en') ? 'fr' : 'en';
            applyI18n();
            updateStats();
        }

        // ----------------------------
        // Modal confirm
        // ----------------------------
        function showConfirm(message, onYes) {
            const modal = $('#custom-confirm-modal');
            const msg = $('#custom-confirm-msg');
            const btnNo = $('#custom-confirm-no');
            const btnYes = $('#custom-confirm-yes');

            msg.textContent = message;
            modal.classList.remove('hidden');

            const clean = () => {
                modal.classList.add('hidden');
                btnNo.onclick = null;
                btnYes.onclick = null;
            };

            btnNo.onclick = () => clean();
            btnYes.onclick = () => {
                clean();
                try { onYes?.(); } catch (e) { console.error(e); }
            };
        }

        // ----------------------------
        // Panels / folding
        // ----------------------------
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            panel.classList.toggle('open');

            // optional icon behaviour
            if (panelId === 'key-params-panel') {
                const icon = $('#key-params-panel-icon');
                if (icon) icon.classList.toggle('open');
            }
        }

        function toggleActivity(btn) {
            const activity = btn.closest('.activity-group');
            if (!activity) return;
            const body = $('.activity-body', activity);
            const icon = $('.rotate-icon', btn);
            const isCollapsed = body.classList.toggle('collapsed');
            if (isCollapsed) body.classList.remove('open');
            else body.classList.add('open');
            if (icon) icon.classList.toggle('open', !isCollapsed);
        }

        function toggleStep(btn) {
            const step = btn.closest('.step-card');
            if (!step) return;
            const body = $('.step-body', step);
            const icon = $('.rotate-icon', btn);
            const isCollapsed = body.classList.toggle('collapsed');
            if (isCollapsed) body.classList.remove('open');
            else body.classList.add('open');
            if (icon) icon.classList.toggle('open', !isCollapsed);
        }

        let ALL_COLLAPSED = false;
        function toggleAllActivities() {
            const activities = $$('.activity-group');
            ALL_COLLAPSED = !ALL_COLLAPSED;
            activities.forEach(a => {
                const body = $('.activity-body', a);
                const btnIcon = $('.rotate-icon', a);
                if (!body) return;
                body.classList.toggle('collapsed', ALL_COLLAPSED);
                body.classList.toggle('open', !ALL_COLLAPSED);
                if (btnIcon) btnIcon.classList.toggle('open', !ALL_COLLAPSED);
            });

            const iconMain = $('#icon-toggle-all-main');
            const iconHeader = $('#icon-toggle-all');
            const textMain = $('#text-toggle-all-main');

            if (iconMain) iconMain.textContent = ALL_COLLAPSED ? 'unfold_more' : 'unfold_less';
            if (iconHeader) iconHeader.textContent = ALL_COLLAPSED ? 'unfold_more' : 'unfold_less';
            if (textMain) textMain.textContent = ALL_COLLAPSED ? (CURRENT_LANG === 'en' ? 'Expand All' : 'Tout déplier') : (I18N[CURRENT_LANG]?.btn_collapse_all || 'Collapse All');
        }

        function switchTab(tab) {
            // Analysis removed. Keep API to prevent errors if called.
            if (tab !== 'designer') return;
            $('#view-designer')?.classList.remove('hidden');
        }

        // ----------------------------
        // Bloom outcomes
        // ----------------------------
        const BLOOM = [
            { level: 'Remember', subs: ['Recognise', 'Recall'] },
            { level: 'Understand', subs: ['Interpret', 'Summarise', 'Explain'] },
            { level: 'Apply', subs: ['Implement', 'Execute'] },
            { level: 'Analyse', subs: ['Differentiate', 'Organise', 'Attribute'] },
            { level: 'Evaluate', subs: ['Check', 'Critique'] },
            { level: 'Create', subs: ['Generate', 'Plan', 'Produce'] }
        ];

        function populateBloom() {
            const levelSel = $('#new-bloom-level');
            const subSel = $('#new-bloom-sub');
            if (!levelSel || !subSel) return;

            // wipe options except placeholder
            while (levelSel.options.length > 1) levelSel.remove(1);
            BLOOM.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.level;
                opt.textContent = b.level;
                levelSel.appendChild(opt);
            });

            while (subSel.options.length > 1) subSel.remove(1);
        }

        function updateHeaderBloomSub() {
            const levelSel = $('#new-bloom-level');
            const subSel = $('#new-bloom-sub');
            if (!levelSel || !subSel) return;

            const chosen = levelSel.value;
            const bloom = BLOOM.find(b => b.level === chosen);
            if (!bloom) {
                subSel.classList.add('hidden');
                return;
            }

            // repopulate subs
            while (subSel.options.length > 1) subSel.remove(1);
            bloom.subs.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                subSel.appendChild(opt);
            });
            subSel.classList.remove('hidden');
        }

        function handleOutcomeEnter(evt) {
            if (evt.key === 'Enter') {
                evt.preventDefault();
                addOutcome();
            }
        }

        function addOutcome() {
            const input = $('#new-outcome-input');
            const list = $('#outcomes-list');
            const noTxt = $('#no-outcomes-text');
            const levelSel = $('#new-bloom-level');
            const subSel = $('#new-bloom-sub');
            if (!input || !list || !noTxt) return;

            const text = input.value.trim();
            if (!text) return;

            const bloomLevel = levelSel?.value || '';
            const bloomSub = (!subSel?.classList.contains('hidden') ? (subSel?.value || '') : '');

            const li = document.createElement('li');
            li.className = 'flex items-start justify-between gap-3 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2';

            const left = document.createElement('div');
            left.className = 'text-sm text-slate-700';

            const tag = document.createElement('span');
            tag.className = 'inline-flex items-center gap-1 text-[10px] font-bold uppercase tracking-wide text-indigo-700 bg-indigo-50 border border-indigo-100 rounded-md px-2 py-0.5 mr-2';
            const tagText = bloomLevel ? `${bloomLevel}${bloomSub ? ` · ${bloomSub}` : ''}` : 'Outcome';
            tag.textContent = tagText;

            const span = document.createElement('span');
            span.textContent = text;

            left.appendChild(tag);
            left.appendChild(span);

            const btn = document.createElement('button');
            btn.className = 'text-slate-400 hover:text-red-500 p-1 shrink-0';
            btn.title = (CURRENT_LANG === 'en') ? 'Remove' : 'Supprimer';
            btn.innerHTML = '<span class="material-icons-round text-lg">close</span>';
            btn.onclick = () => {
                li.remove();
                if (list.children.length === 0) noTxt.classList.remove('hidden');
            };

            li.appendChild(left);
            li.appendChild(btn);
            list.appendChild(li);

            input.value = '';
            noTxt.classList.add('hidden');
        }

        // ----------------------------
        // Sortable setup
        // ----------------------------
        let activitiesSortable = null;

        function ensureSortables() {
            const root = $('#activities-root');
            if (!root) return;

            if (window.Sortable && !activitiesSortable) {
                activitiesSortable = new Sortable(root, {
                    animation: 150,
                    handle: '.drag-handle-activity',
                    draggable: '.activity-group',
                    onEnd: () => {
                        renumberActivities();
                        updateStats();
                    }
                });
            }

            // steps sortable per activity
            $$('.activity-group').forEach(activity => {
                const stepsContainer = $('.activity-steps-container', activity);
                if (!stepsContainer) return;
                if (stepsContainer._sortable) return;
                if (!window.Sortable) return;

                stepsContainer._sortable = new Sortable(stepsContainer, {
                    animation: 150,
                    handle: '.drag-handle-step',
                    draggable: '.step-card',
                    onEnd: () => updateStats()
                });
            });
        }

        // ----------------------------
        // Core creation / editing
        // ----------------------------
        function addActivity() {
            const tpl = $('#activity-template');
            const root = $('#activities-root');
            if (!tpl || !root) return;

            const node = tpl.content.firstElementChild.cloneNode(true);
            root.appendChild(node);

            // show/hide empty state
            $('#empty-state')?.classList.add('hidden');

            ensureSortables();
            renumberActivities();
            updateStats();
        }

        function deleteActivity(btn) {
            const activity = btn.closest('.activity-group');
            if (!activity) return;
            showConfirm(CURRENT_LANG === 'en' ? 'Delete this activity?' : 'Supprimer cette activité ?', () => {
                activity.remove();
                renumberActivities();
                updateStats();
            });
        }

        function duplicateActivity(btn) {
            const activity = btn.closest('.activity-group');
            const root = $('#activities-root');
            if (!activity || !root) return;

            const clone = activity.cloneNode(true);
            // Clear any Sortable refs
            const stepsContainer = $('.activity-steps-container', clone);
            if (stepsContainer) stepsContainer._sortable = null;

            // Rebind events that rely on inline attributes are already present.
            root.insertBefore(clone, activity.nextSibling);

            ensureSortables();
            renumberActivities();
            updateStats();
        }

        function addStepToActivity(btn) {
            const activity = btn.closest('.activity-group');
            const container = activity ? $('.activity-steps-container', activity) : null;
            const tpl = $('#step-template');
            if (!container || !tpl) return;

            const step = tpl.content.firstElementChild.cloneNode(true);
            container.appendChild(step);

            ensureSortables();
            updateStats();
        }

        function deleteStep(btn) {
            const step = btn.closest('.step-card');
            if (!step) return;
            showConfirm(CURRENT_LANG === 'en' ? 'Delete this step?' : 'Supprimer cette étape ?', () => {
                step.remove();
                updateStats();
            });
        }

        function duplicateStep(btn) {
            const step = btn.closest('.step-card');
            if (!step) return;
            const clone = step.cloneNode(true);
            step.parentElement.insertBefore(clone, step.nextSibling);
            updateStats();
        }

        function updateStepType(selectEl) {
            const step = selectEl.closest('.step-card');
            if (!step) return;

            // remove all type classes
            Object.values(TYPE_CLASS).forEach(c => step.classList.remove(c));
            Object.values(SELECT_CLASS).forEach(c => selectEl.classList.remove(c));

            const t = selectEl.value;
            step.classList.add(TYPE_CLASS[t] || TYPE_CLASS.acquisition);
            selectEl.classList.add(SELECT_CLASS[t] || SELECT_CLASS.acquisition);

            updateStats();
        }

        function toggleGroupMode(selectEl) {
            const step = selectEl.closest('.step-card');
            if (!step) return;
            const details = $('.step-group-details', step);
            if (!details) return;

            const mode = selectEl.value;
            details.classList.toggle('hidden', mode !== 'groups');
            updateStats();
        }

        function updateGroupMath(inputEl, mode) {
            const step = inputEl.closest('.step-card');
            if (!step) return;

            const cohort = safeNumber($('#global-class-size')?.value, 0);
            const countEl = $('.step-group-count', step);
            const sizeEl = $('.step-group-size', step);
            if (!countEl || !sizeEl) return;

            const count = safeNumber(countEl.value, 0);
            const size = safeNumber(sizeEl.value, 0);

            if (cohort <= 0) return;

            if (mode === 'count') {
                const c = clamp(count, 1, 9999);
                if (countEl.value !== String(c)) countEl.value = String(c);
                const computedSize = Math.max(1, Math.round(cohort / c));
                if (!sizeEl.value) sizeEl.value = String(computedSize);
            } else {
                const s = clamp(size, 1, 9999);
                if (sizeEl.value !== String(s)) sizeEl.value = String(s);
                const computedCount = Math.max(1, Math.round(cohort / s));
                if (!countEl.value) countEl.value = String(computedCount);
            }
        }

        function renumberActivities() {
            const activities = $$('.activity-group');
            activities.forEach((a, idx) => {
                const badge = $('.activity-index', a);
                if (badge) badge.textContent = String(idx + 1);
            });
            if (activities.length === 0) $('#empty-state')?.classList.remove('hidden');
            else $('#empty-state')?.classList.add('hidden');
        }

        // ----------------------------
        // Stats + timelines
        // ----------------------------
        function getStepSeconds(step) {
            const val = safeNumber($('.duration-input', step)?.value, 0);
            const unitSeconds = safeNumber($('.duration-unit', step)?.value, 60);
            return Math.max(0, val * unitSeconds);
        }

        function updateStats() {
            const t0 = performance.now();

            // header target time
            const targetVal = safeNumber($('#param-learning-val')?.value, 0);
            const targetUnit = $('#param-learning-unit')?.value || 'mins';
            const targetLabel = `${targetVal} ${I18N[CURRENT_LANG]?.['unit_' + targetUnit] || targetUnit}`;
            $('#header-target-time').textContent = targetLabel;

            // total planned
            const steps = $$('.step-card');
            let totalSeconds = 0;
            steps.forEach(s => { totalSeconds += getStepSeconds(s); });

            $('#total-duration').textContent = formatDuration(totalSeconds);

            // designed time displayed using the target unit
            const designed = convertSecondsToUnit(totalSeconds, targetUnit);
            $('#param-designed-unit-display').textContent = I18N[CURRENT_LANG]?.['unit_' + targetUnit] || targetUnit;
            $('#param-designed-val').value = designed ? String(Math.round(designed * 10) / 10) : '0';

            renderActivityTimeline(totalSeconds);
            renderTypeTimeline(totalSeconds);
            renderRuler(totalSeconds);

            // activity mini bars
            updateActivityMiniBars();

            const t1 = performance.now();
            $('#stats-update-info').textContent = (CURRENT_LANG === 'en') ? `Updated (${Math.round(t1 - t0)} ms)` : `Mis à jour (${Math.round(t1 - t0)} ms)`;
        }

        function renderActivityTimeline(totalSeconds) {
            const bar = $('#timeline-activities');
            const labels = $('#timeline-activities-labels');
            if (!bar || !labels) return;

            bar.innerHTML = '';
            labels.innerHTML = '';

            const activities = $$('.activity-group');
            if (activities.length === 0 || totalSeconds <= 0) {
                bar.innerHTML = '<div class="flex-1"></div>';
                return;
            }

            activities.forEach((a, idx) => {
                const steps = $$('.step-card', a);
                const seconds = steps.reduce((acc, s) => acc + getStepSeconds(s), 0);
                const pct = seconds / totalSeconds;

                const seg = document.createElement('div');
                seg.style.flex = String(Math.max(0.01, pct));
                seg.className = 'h-full';
                seg.style.background = idx % 2 === 0 ? '#e2e8f0' : '#cbd5e1';
                seg.title = `${($('.activity-title', a)?.value || `Activity ${idx + 1}`)} · ${formatDuration(seconds)}`;
                bar.appendChild(seg);

                const lab = document.createElement('div');
                lab.style.flex = String(Math.max(0.01, pct));
                lab.className = 'truncate pr-2';
                lab.textContent = `A${idx + 1}`;
                labels.appendChild(lab);
            });
        }

        function renderTypeTimeline(totalSeconds) {
            const bar = $('#timeline-steps');
            if (!bar) return;
            bar.innerHTML = '';

            const steps = $$('.step-card');
            if (steps.length === 0 || totalSeconds <= 0) {
                bar.innerHTML = '<div class="flex-1"></div>';
                return;
            }

            steps.forEach(step => {
                const seconds = getStepSeconds(step);
                const pct = seconds / totalSeconds;

                const sel = $('.learning-type-select', step);
                const type = sel?.value || 'acquisition';

                const seg = document.createElement('div');
                seg.style.flex = String(Math.max(0.01, pct));
                seg.className = 'h-full';
                seg.style.background = TYPE_COLOURS[type] || TYPE_COLOURS.acquisition;
                seg.title = `${type} · ${formatDuration(seconds)}`;
                bar.appendChild(seg);
            });
        }

        function renderRuler(totalSeconds) {
            const ruler = $('#timeline-ruler');
            if (!ruler) return;
            ruler.innerHTML = '';

            if (totalSeconds <= 0) return;

            const mins = Math.round(totalSeconds / 60);
            const ticks = 5;
            for (let i = 0; i <= ticks; i++) {
                const pct = (i / ticks) * 100;
                const tick = document.createElement('div');
                tick.className = 'absolute top-0';
                tick.style.left = `${pct}%`;
                tick.style.transform = 'translateX(-50%)';
                tick.innerHTML = `<div class="h-2 w-px bg-slate-300"></div><div class="text-[9px] text-slate-400 mt-0.5">${Math.round((mins * i) / ticks)}m</div>`;
                ruler.appendChild(tick);
            }
        }

        function updateActivityMiniBars() {
            const activities = $$('.activity-group');
            activities.forEach(a => {
                const steps = $$('.step-card', a);
                const total = steps.reduce((acc, s) => acc + getStepSeconds(s), 0);
                const bar = $('.activity-type-bar', a);
                const time = $('.activity-total-time', a);
                if (time) time.textContent = total ? `${Math.round(total / 60)}m` : '0m';
                if (!bar) return;

                bar.innerHTML = '';
                const byType = { acquisition: 0, collaboration: 0, discussion: 0, investigation: 0, practice: 0, production: 0 };
                steps.forEach(s => {
                    const sec = getStepSeconds(s);
                    const t = $('.learning-type-select', s)?.value || 'acquisition';
                    byType[t] = (byType[t] || 0) + sec;
                });

                const denom = total || 1;
                Object.keys(byType).forEach(t => {
                    const sec = byType[t];
                    if (sec <= 0) return;
                    const seg = document.createElement('div');
                    seg.style.flex = String(Math.max(0.01, sec / denom));
                    seg.style.background = TYPE_COLOURS[t] || TYPE_COLOURS.acquisition;
                    bar.appendChild(seg);
                });
            });
        }

        // ----------------------------
        // Save / Load
        // ----------------------------
        function serializeProject() {
            const project = {
                meta: {
                    name: $('#param-name')?.value || '',
                    topic: $('#param-topic')?.value || '',
                    authors: $('#param-authors')?.value || '',
                    mode: $('#param-mode')?.value || '',
                    cohortSize: safeNumber($('#global-class-size')?.value, 0),
                    targetTime: {
                        value: safeNumber($('#param-learning-val')?.value, 0),
                        unit: $('#param-learning-unit')?.value || 'mins'
                    },
                    aims: $('#param-aims')?.value || '',
                    description: $('#param-description')?.value || ''
                },
                outcomes: $$('#outcomes-list li').map(li => {
                    const text = li.innerText.replace(/\s+/g, ' ').trim();
                    return { text };
                }),
                activities: $$('.activity-group').map(a => ({
                    title: $('.activity-title', a)?.value || '',
                    description: $('.activity-description', a)?.value || '',
                    steps: $$('.step-card', a).map(s => ({
                        title: $('.step-input-title', s)?.value || '',
                        type: $('.learning-type-select', s)?.value || 'acquisition',
                        duration: {
                            value: safeNumber($('.duration-input', s)?.value, 0),
                            unitSeconds: safeNumber($('.duration-unit', s)?.value, 60)
                        },
                        grouping: {
                            mode: $('.step-group-mode', s)?.value || 'class',
                            groupCount: safeNumber($('.step-group-count', s)?.value, 0),
                            groupSize: safeNumber($('.step-group-size', s)?.value, 0)
                        },
                        context: {
                            trainer: $('.trainer-select', s)?.value || 'present',
                            place: $('.place-select', s)?.value || 'situ',
                            time: $('.time-select', s)?.value || 'sync'
                        },
                        tasks: $('.step-input-tasks', s)?.value || '',
                        notes: $('.step-input-notes', s)?.value || ''
                    }))
                }))
            };
            return project;
        }

        function hydrateProject(project) {
            // clear existing
            $('#activities-root').innerHTML = '';
            $('#outcomes-list').innerHTML = '';
            $('#no-outcomes-text').classList.remove('hidden');

            // meta
            $('#param-name').value = project?.meta?.name || '';
            $('#param-topic').value = project?.meta?.topic || '';
            $('#param-authors').value = project?.meta?.authors || '';
            $('#param-mode').value = project?.meta?.mode || '';
            $('#global-class-size').value = String(project?.meta?.cohortSize || 30);

            $('#param-learning-val').value = String(project?.meta?.targetTime?.value ?? '');
            $('#param-learning-unit').value = project?.meta?.targetTime?.unit || 'mins';

            $('#param-aims').value = project?.meta?.aims || '';
            $('#param-description').value = project?.meta?.description || '';

            // outcomes (simple)
            (project?.outcomes || []).forEach(o => {
                $('#new-outcome-input').value = o.text || '';
                addOutcome();
            });

            // activities
            (project?.activities || []).forEach(a => {
                addActivity();
                const node = $$('.activity-group').slice(-1)[0];
                if (!node) return;
                $('.activity-title', node).value = a.title || '';
                $('.activity-description', node).value = a.description || '';

                (a.steps || []).forEach(s => {
                    const addBtn = $('[onclick="addStepToActivity(this)"]', node);
                    addStepToActivity(addBtn);
                    const stepNode = $$('.step-card', node).slice(-1)[0];
                    if (!stepNode) return;

                    $('.step-input-title', stepNode).value = s.title || '';
                    const typeSel = $('.learning-type-select', stepNode);
                    typeSel.value = s.type || 'acquisition';
                    updateStepType(typeSel);

                    $('.duration-input', stepNode).value = String(s.duration?.value ?? '');
                    $('.duration-unit', stepNode).value = String(s.duration?.unitSeconds ?? 60);

                    $('.step-group-mode', stepNode).value = s.grouping?.mode || 'class';
                    toggleGroupMode($('.step-group-mode', stepNode));
                    $('.step-group-count', stepNode).value = String(s.grouping?.groupCount ?? '');
                    $('.step-group-size', stepNode).value = String(s.grouping?.groupSize ?? '');

                    $('.trainer-select', stepNode).value = s.context?.trainer || 'present';
                    $('.place-select', stepNode).value = s.context?.place || 'situ';
                    $('.time-select', stepNode).value = s.context?.time || 'sync';

                    $('.step-input-tasks', stepNode).value = s.tasks || '';
                    $('.step-input-notes', stepNode).value = s.notes || '';
                });
            });

            ensureSortables();
            renumberActivities();
            updateStats();
        }

        function saveProject() {
            const data = serializeProject();
            const name = (data.meta.name || 'learning-designer').replace(/[^a-z0-9\-\_]+/gi, '_');
            downloadText(`${name}.json`, JSON.stringify(data, null, 2), 'application/json;charset=utf-8');
        }

        function triggerFileLoad() {
            $('#load-file-input')?.click();
        }

        function loadProject(event) {
            const file = event?.target?.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const json = JSON.parse(String(reader.result || '{}'));
                    hydrateProject(json);
                } catch (e) {
                    console.error(e);
                    alert(CURRENT_LANG === 'en' ? 'Invalid JSON file.' : 'Fichier JSON invalide.');
                }
            };
            reader.readAsText(file);
            // reset input
            event.target.value = '';
        }

        // ----------------------------
        // Export
        // ----------------------------
        function exportAsMarkdown() {
            const p = serializeProject();
            const lines = [];
            lines.push(`# ${p.meta.name || 'Learning Design'}`);
            if (p.meta.topic) lines.push(`**Topic:** ${p.meta.topic}`);
            if (p.meta.authors) lines.push(`**Author(s):** ${p.meta.authors}`);
            if (p.meta.mode) lines.push(`**Mode:** ${p.meta.mode}`);
            lines.push('');

            if (p.meta.aims) {
                lines.push('## Aims');
                lines.push(p.meta.aims);
                lines.push('');
            }

            if (p.outcomes.length) {
                lines.push('## Learning outcomes');
                p.outcomes.forEach(o => lines.push(`- ${o.text}`));
                lines.push('');
            }

            p.activities.forEach((a, i) => {
                lines.push(`## Activity ${i + 1}: ${a.title || ''}`.trim());
                if (a.description) lines.push(a.description);
                lines.push('');

                a.steps.forEach((s, j) => {
                    const unit = s.duration.unitSeconds;
                    const unitLabel = unit === 60 ? 'mins' : unit === 3600 ? 'hours' : unit === 86400 ? 'days' : 'weeks';
                    lines.push(`### Step ${j + 1}: ${s.title || ''}`.trim());
                    lines.push(`- Type: ${s.type}`);
                    lines.push(`- Duration: ${s.duration.value} ${unitLabel}`);
                    lines.push(`- Trainer: ${s.context.trainer}; Place: ${s.context.place}; Time: ${s.context.time}`);
                    lines.push(`- Grouping: ${s.grouping.mode}${s.grouping.mode === 'groups' ? ` (${s.grouping.groupCount || '?'} groups · ${s.grouping.groupSize || '?'} per group)` : ''}`);
                    if (s.tasks) {
                        lines.push('');
                        lines.push('**Learner tasks**');
                        lines.push(s.tasks);
                    }
                    if (s.notes) {
                        lines.push('');
                        lines.push('**Notes**');
                        lines.push(s.notes);
                    }
                    lines.push('');
                });
            });

            return lines.join('\n');
        }

        function exportAsRichTextHTML() {
            const p = serializeProject();
            const esc = (s) => String(s || '').replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));

            let html = `<!doctype html><html><head><meta charset="utf-8"><title>${esc(p.meta.name || 'Learning Design')}</title>` +
                `<style>body{font-family:Inter,Arial,sans-serif;margin:40px;line-height:1.4}h1,h2,h3{margin:0 0 .4em}hr{border:none;border-top:1px solid #ddd;margin:20px 0}.meta{color:#555}</style></head><body>`;

            html += `<h1>${esc(p.meta.name || 'Learning Design')}</h1>`;
            html += `<div class="meta">${p.meta.topic ? `<div><strong>Topic:</strong> ${esc(p.meta.topic)}</div>` : ''}${p.meta.authors ? `<div><strong>Author(s):</strong> ${esc(p.meta.authors)}</div>` : ''}${p.meta.mode ? `<div><strong>Mode:</strong> ${esc(p.meta.mode)}</div>` : ''}</div>`;

            if (p.meta.aims) html += `<h2>Aims</h2><p>${esc(p.meta.aims)}</p>`;
            if (p.outcomes.length) {
                html += `<h2>Learning outcomes</h2><ul>`;
                p.outcomes.forEach(o => { html += `<li>${esc(o.text)}</li>`; });
                html += `</ul>`;
            }

            p.activities.forEach((a, i) => {
                html += `<hr><h2>Activity ${i + 1}: ${esc(a.title)}</h2>`;
                if (a.description) html += `<p>${esc(a.description)}</p>`;

                (a.steps || []).forEach((s, j) => {
                    html += `<h3>Step ${j + 1}: ${esc(s.title)}</h3>`;
                    html += `<ul>`;
                    html += `<li><strong>Type:</strong> ${esc(s.type)}</li>`;
                    html += `<li><strong>Duration:</strong> ${esc(s.duration.value)} (unit seconds: ${esc(s.duration.unitSeconds)})</li>`;
                    html += `<li><strong>Trainer / Place / Time:</strong> ${esc(s.context.trainer)} / ${esc(s.context.place)} / ${esc(s.context.time)}</li>`;
                    html += `</ul>`;
                    if (s.tasks) html += `<p><strong>Learner tasks</strong><br>${esc(s.tasks).replace(/\n/g,'<br>')}</p>`;
                    if (s.notes) html += `<p><strong>Notes</strong><br>${esc(s.notes).replace(/\n/g,'<br>')}</p>`;
                });
            });

            html += `</body></html>`;
            return html;
        }

        function exportAsRTF() {
            const md = exportAsMarkdown();
            // very small RTF wrapper; Markdown will appear as plain text.
            const escaped = md
                .replace(/\\/g, '\\\\')
                .replace(/{/g, '\\{')
                .replace(/}/g, '\\}')
                .replace(/\n/g, '\\par\n');
            return `{\\rtf1\\ansi\\deff0\n${escaped}\n}`;
        }

        function handleExport(select) {
            const val = select.value;
            if (!val) return;

            try {
                if (val === 'markdown') {
                    const content = exportAsMarkdown();
                    downloadText('learning-design.md', content, 'text/markdown;charset=utf-8');
                } else if (val === 'pdf') {
                    // Use browser print-to-PDF.
                    window.print();
                } else if (val === 'richtext') {
                    const html = exportAsRichTextHTML();
                    const w = window.open('', '_blank');
                    if (w) {
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                    }
                } else if (val === 'rtf') {
                    const rtf = exportAsRTF();
                    downloadText('learning-design.rtf', rtf, 'application/rtf;charset=utf-8');
                }
            } finally {
                // reset to placeholder
                select.value = '';
            }
        }

        function exportTerminology() {
            // Export i18n dictionary for editing.
            downloadText('terminology.json', JSON.stringify(I18N, null, 2), 'application/json;charset=utf-8');
        }

        // ----------------------------
        // Tooltips (optional)
        // ----------------------------
        function attachTooltips() {
            const tooltip = $('#global-tooltip');
            if (!tooltip) return;

            const show = (evt, text) => {
                tooltip.textContent = text;
                tooltip.classList.remove('hidden');
                tooltip.style.left = `${evt.clientX + 12}px`;
                tooltip.style.top = `${evt.clientY + 12}px`;
            };

            const hide = () => tooltip.classList.add('hidden');

            const bars = ['#timeline-activities', '#timeline-steps'];
            bars.forEach(sel => {
                const el = $(sel);
                if (!el) return;
                el.addEventListener('mousemove', (evt) => {
                    show(evt, CURRENT_LANG === 'en' ? 'Timeline is proportional to planned duration.' : 'La chronologie est proportionnelle à la durée planifiée.');
                });
                el.addEventListener('mouseleave', hide);
            });
        }

        // ----------------------------
        // Smoke tests (console)
        // ----------------------------
        function runSmokeTests() {
            try {
                console.assert(typeof addActivity === 'function', 'addActivity should be defined');
                const before = $$('.activity-group').length;
                addActivity();
                const after = $$('.activity-group').length;
                console.assert(after === before + 1, 'addActivity should add one activity');

                const act = $$('.activity-group')[0];
                const btn = $('[onclick="addStepToActivity(this)"]', act);
                const stepsBefore = $$('.step-card', act).length;
                addStepToActivity(btn);
                const stepsAfter = $$('.step-card', act).length;
                console.assert(stepsAfter === stepsBefore + 1, 'addStepToActivity should add one step');

                // cleanup to avoid polluting user
                act.remove();
                renumberActivities();
                updateStats();

                console.log('Smoke tests passed.');
            } catch (e) {
                console.error('Smoke tests failed:', e);
            }
        }

        // ----------------------------
        // Init
        // ----------------------------
        document.addEventListener('DOMContentLoaded', () => {
            populateBloom();
            applyI18n();
            ensureSortables();
            renumberActivities();
            updateStats();
            attachTooltips();
            // Keep these disabled by default; uncomment during development.
            runSmokeTests();
        });
    </script>
</body>
</html>
